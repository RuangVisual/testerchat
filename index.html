<!--
Dynamic Amik Overlay
CSS Theme System for Social Stream Ninja
Core logic untouched – CSS only override
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynamic Amik Overlay</title>
  <meta name="robots" content="noindex,nofollow">

  <!-- THEME CSS (DYNAMIC + WHITELISTED) -->
  <link id="theme-style" rel="stylesheet">
</head>

<body>
  <!-- CHAT OUTPUT -->
  <div id="output" class="output"></div>
  
  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const themeParam = (params.get("theme") || "").toLowerCase();

      const ALLOWED_THEMES = [
        "black_purple",
        "box_pic",
        "comic_yellow",
        "cute_purple",
        "dynamic_island",
        "dynamic_island_yellow",
        "elegant_popup_black",
        "elegant_popup_white",
        "feminine_pink",
        "feminine_windows",
        "galaxy_purple",
        "iphone",
        "iphone_black",
        "mac_player_black",
        "mac_player_white",
        "minimalist",
        "minimalist_border_style_1",
        "minimalist_border_style_2",
        "pixel_cartoon_8bit",
        "tiktok",
        "tiktok_black"
      ];

      const finalTheme = ALLOWED_THEMES.includes(themeParam)
        ? themeParam
        : "dynamic_island";

      document.getElementById("theme-style").href =
        `/themes/${finalTheme}.css`;
    })();
  </script>

  <!-- =========================
       SOCIAL STREAM NINJA CORE
       ⚠️ DO NOT MODIFY
  ========================== -->
  <script>
    const urlParams = new URLSearchParams(window.location.search);

    const App = {
      config: {
        serverURL: (urlParams.has("localserver")
          ? "ws://127.0.0.1:3000"
          : "wss://io.socialstream.ninja"),
        maxReconnectAttempts: 10,
        reconnectDelay: 100,
        roomIdMaxLength: 80
      },

      state: {
        socketserver: null,
        reconnectionTimeout: null,
        conCon: 1,
        roomID: "test",
        password: "false",
        fallbackImage: null,
        fallbackImageAnnouncement: null
      },

      init() {
        this.setupUrlParams();
        this.setupFallbackImages();
        this.initializeConnection();
      },

      initializeConnection() {
        if (urlParams.has("server")) {
          this.config.serverURL = urlParams.get("server") || this.config.serverURL;
          this.setupSocket();
        } else if (urlParams.has("server2")) {
          this.config.serverURL = urlParams.get("server2") || this.config.serverURL;
          this.setupSocket(1);
        } else if (urlParams.has("server3")) {
          this.config.serverURL = urlParams.get("server3") || this.config.serverURL;
          this.setupSocket(2);
        } else {
          this.setupRecvDataWindow();
        }
      },

      setupUrlParams() {
        const params = new URLSearchParams(window.location.search);
        this.handleRoomIdParam(params);
        this.handlePasswordParam(params);
        this.handleServerParam(params);
      },

      handlePasswordParam(params) {
        this.state.password = params.get("password") || "false";
      },

      handleServerParam(params) {
        if (params.has("server")) {
          this.config.serverURL = params.get("server") || this.config.serverURL;
        } else if (params.has("server2")) {
          this.config.serverURL = params.get("server2") || this.config.serverURL;
        } else if (params.has("server3")) {
          this.config.serverURL = params.get("server3") || this.config.serverURL;
        }
      },

      setupRecvDataWindow() {
        const iframe = document.createElement("iframe");
        iframe.src =
          `https://vdo.socialstream.ninja/?ln&password=${this.state.password}` +
          `&notmobile&salt=vdo.ninja&label=overlay&exclude=${this.state.roomID}` +
          `&scene&novideo&noaudio&cleanoutput&room=${this.state.roomID}`;
        iframe.id = "frame1";
        iframe.style.display = "none";
        document.body.appendChild(iframe);

        window.addEventListener("message", (e) => {
          if (e.source !== iframe.contentWindow) return;
          if (e.data?.dataReceived?.overlayNinja !== undefined) {
            this.processData(
              e.data.dataReceived.overlayNinja
                ? { contents: e.data.dataReceived.overlayNinja }
                : false
            );
          }
        });
      },

      handleRoomIdParam(params) {
        let roomID = params.get("session") || params.get("s") || params.get("id");
        if (!roomID) {
          document.body.innerHTML = "";
          return;
        }
        const valid = this.validateRoomId(roomID);
        if (!valid) {
          document.body.innerHTML = "";
          return;
        }
        this.state.roomID = valid;
      },

      setupFallbackImages() {
        this.state.fallbackImage = new Image();
        this.state.fallbackImage.src = "./sources/images/unknown.png";
        this.state.fallbackImage.onerror = () => (this.state.fallbackImage = null);
      },

      validateRoomId(roomId) {
        if (!roomId?.trim()) return false;
        const id = roomId.trim().replace(/[^a-zA-Z0-9]/g, "_");
        return id.length >= 2 && id.length <= this.config.roomIdMaxLength
          ? id
          : false;
      },

      setupSocket(allin = false) {
        if (this.state.socketserver) this.state.socketserver.close();
        this.state.socketserver = new WebSocket(this.config.serverURL);
        this.initializeSocketHandlers(allin);
      },

      initializeSocketHandlers(allin) {
        const socket = this.state.socketserver;

        socket.onopen = () => {
          const msg = { join: this.state.roomID, out: 3 };
          if (allin === 1) msg.in = 1;
          if (allin === 2) msg.in = 2;
          socket.send(JSON.stringify(msg));
        };

        socket.onmessage = (event) => {
          if (!event.data) return;
          let data;
          try {
            data = JSON.parse(event.data);
          } catch {
            return;
          }
          if (data.overlayNinja) data = data.overlayNinja;
          this.processData(data);
        };
      },

      processData(data) {
        if (!data || data === false) {
          document.getElementById("output").innerHTML = "";
          return;
        }
        if (data.contents) this.showMessage(data.contents);
      },

      showMessage(data) {
        document.getElementById("output").innerHTML = `
          <div class="hl-c-cont highlight-chat" id="newmessage">
            <div class="hl-title">
              <div class="hl-img">
                <img class="hl-profile-pic" src="${data.chatimg || ""}">
              </div>
              <div class="hl-name">${data.chatname || ""}</div>
            </div>
            <div class="hl-message">${data.chatmessage || ""}</div>
          </div>
        `;
      }
    };

    document.addEventListener("DOMContentLoaded", () => App.init());
  </script>
</body>
</html>
